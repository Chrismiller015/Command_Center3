<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        body {
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
            font-family: 'Inter', sans-serif;
            overflow-y: hidden;
        }
        /* Style the Quill editor toolbar and content area */
        .ql-toolbar {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151 !important; /* border-gray-700 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .ql-container {
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #374151 !important; /* border-gray-700 */
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            color: #d1d5db;
            font-size: 1rem;
            height: calc(100vh - 280px); /* Adjust height as needed */
        }
        .ql-snow .ql-stroke { stroke: #9ca3af; }
        .ql-snow .ql-fill, .ql-snow .ql-stroke.ql-fill { fill: #9ca3af; }
        .ql-snow .ql-picker { color: #9ca3af; }
        .note-item.active { background-color: #4f46e5; } /* bg-indigo-600 */
        .note-item.active h3, .note-item.active p { color: white; }
    </style>
</head>
<body class="h-screen">
    <div id="plugin-container" class="flex h-full">

        <div class="w-1/3 border-r border-gray-800 flex flex-col">
            <div class="p-4 border-b border-gray-800">
                <input type="search" id="search-bar" placeholder="Search notes & tags..." class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2">
            </div>
            <div class="flex-1 overflow-y-auto" id="notes-list">
                </div>
            <div class="p-4 border-t border-gray-800">
                <button id="new-note-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">New Note</button>
            </div>
        </div>

        <div id="editor-area" class="w-2/3 p-4 flex flex-col hidden">
            <div id="editor" class="flex-grow"></div>
            <div class="mt-4">
                <label for="tags-input" class="text-sm font-medium text-gray-400">Tags (comma-separated)</label>
                <input type="text" id="tags-input" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 mt-1">
            </div>
            <div class="mt-4 flex justify-end">
                <button id="delete-note-btn" class="bg-rose-600 text-white font-bold py-2 px-4 rounded-md hover:bg-rose-700">Delete Note</button>
            </div>
        </div>
        
        <div id="placeholder-area" class="w-2/3 p-4 flex items-center justify-center">
            <div class="text-center text-gray-500">
                <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <p class="mt-2 text-xl font-semibold">Select a note to view or edit</p>
                <p>Or create a <a href="#" id="placeholder-new-note" class="text-indigo-400 hover:underline">new note</a> to get started.</p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // --- CONFIGURATION ---
                const PLUGIN_ID = 'notes-plugin';
                // FIX: Sanitize the plugin ID to create the correct table name, replacing hyphens.
                const SAFE_PLUGIN_ID = PLUGIN_ID.replace(/-/g, '_');
                const NOTES_TABLE = `plugin_${SAFE_PLUGIN_ID}_notes`;


                // --- UI ELEMENTS ---
                const searchBar = document.getElementById('search-bar');
                const notesListEl = document.getElementById('notes-list');
                const newNoteBtn = document.getElementById('new-note-btn');
                const placeholderNewNoteLink = document.getElementById('placeholder-new-note');
                const deleteNoteBtn = document.getElementById('delete-note-btn');
                const tagsInput = document.getElementById('tags-input');
                const editorArea = document.getElementById('editor-area');
                const placeholderArea = document.getElementById('placeholder-area');

                // --- STATE ---
                let allNotes = [];
                let activeNoteId = null;
                let saveTimeout;

                // --- QUILL EDITOR SETUP ---
                const quill = new Quill('#editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link', 'blockquote', 'code-block'],
                            ['clean']
                        ]
                    }
                });

                // --- CORE FUNCTIONS ---

                /** Formats a date string into a more readable format. */
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                }

                /** Renders the list of notes on the left panel. */
                const renderNotesList = (notesToRender) => {
                    notesListEl.innerHTML = '';
                    if (notesToRender.length === 0) {
                        notesListEl.innerHTML = '<p class="text-center text-gray-500 p-4">No notes found.</p>';
                        return;
                    }
                    notesToRender.forEach(note => {
                        const firstLine = note.content.replace(/<[^>]+>/g, '').split('\\n')[0].trim();
                        const title = firstLine.substring(0, 40) || 'New Note';
                        const item = document.createElement('div');
                        item.className = `note-item p-4 border-b border-gray-800 cursor-pointer hover:bg-gray-700 ${note.id === activeNoteId ? 'active' : ''}`;
                        item.dataset.id = note.id;
                        item.innerHTML = `
                            <h3 class="font-bold truncate">${title}</h3>
                            <p class="text-sm text-gray-400">Updated: ${formatDate(note.updatedAt)}</p>
                            <p class="text-sm text-indigo-400 truncate mt-1">${note.tags.split(',').join(' ')}</p>
                        `;
                        item.addEventListener('click', () => displayNote(note.id));
                        notesListEl.appendChild(item);
                    });
                };

                /** Fetches all notes from the database and renders them. */
                const loadNotes = async () => {
                    try {
                        const query = `SELECT * FROM ${NOTES_TABLE} ORDER BY updatedAt DESC`;
                        allNotes = await window.electronAPI.dbAll(PLUGIN_ID, query);
                        renderNotesList(allNotes);
                    } catch (err) {
                        console.error("Failed to load notes:", err);
                        notesListEl.innerHTML = `<p class="text-red-400 p-4">Error: Could not load notes from database.</p>`;
                    }
                };

                /** Displays a selected note in the editor. */
                const displayNote = (id) => {
                    activeNoteId = id;
                    const note = allNotes.find(n => n.id === id);
                    if (note) {
                        quill.root.innerHTML = note.content;
                        tagsInput.value = note.tags;
                        editorArea.classList.remove('hidden');
                        placeholderArea.classList.add('hidden');
                        renderNotesList(allNotes.filter(n => n.id === n.id)); // Re-render to highlight active
                    }
                    renderNotesList(allNotes); // Update active highlighting
                };

                /** Handles creating or updating a note. */
                const saveNote = async () => {
                    const content = quill.root.innerHTML;
                    const tags = tagsInput.value.trim();
                    const now = new Date().toISOString();

                    try {
                        if (activeNoteId) { // Update existing note
                            const sql = `UPDATE ${NOTES_TABLE} SET content = ?, tags = ?, updatedAt = ? WHERE id = ?`;
                            await window.electronAPI.dbRun(PLUGIN_ID, sql, [content, tags, now, activeNoteId]);
                        } else { // Create new note
                            const sql = `INSERT INTO ${NOTES_TABLE} (content, tags, createdAt, updatedAt) VALUES (?, ?, ?, ?)`;
                            const result = await window.electronAPI.dbRun(PLUGIN_ID, sql, [content, tags, now, now]);
                            activeNoteId = result.lastID; // Set the new ID as active
                        }
                        await loadNotes(); // Reload to show changes
                        displayNote(activeNoteId); // Ensure the new note stays displayed
                    } catch (err) {
                        console.error("Save failed:", err);
                    }
                };

                /** Handles the logic for creating a new note. */
                const createNewNote = () => {
                    activeNoteId = null;
                    quill.root.innerHTML = '';
                    tagsInput.value = '';
                    editorArea.classList.remove('hidden');
                    placeholderArea.classList.add('hidden');
                    quill.focus();
                    renderNotesList(allNotes); // Un-highlight any previously active notes
                };

                /** Handles deleting the currently active note. */
                const deleteCurrentNote = async () => {
                    if (!activeNoteId) return;

                    if (confirm('Are you sure you want to delete this note permanently?')) {
                        try {
                            const sql = `DELETE FROM ${NOTES_TABLE} WHERE id = ?`;
                            await window.electronAPI.dbRun(PLUGIN_ID, sql, [activeNoteId]);
                            activeNoteId = null;
                            editorArea.classList.add('hidden');
                            placeholderArea.classList.remove('hidden');
                            await loadNotes();
                        } catch (err) {
                            console.error("Delete failed:", err);
                        }
                    }
                };
                
                /** Filters notes based on the search input. */
                const searchNotes = () => {
                    const term = searchBar.value.toLowerCase();
                    if (!term) {
                        renderNotesList(allNotes);
                        return;
                    }
                    const filteredNotes = allNotes.filter(note => {
                        const contentText = note.content.replace(/<[^>]+>/g, '').toLowerCase();
                        const tagsText = note.tags.toLowerCase();
                        return contentText.includes(term) || tagsText.includes(term);
                    });
                    renderNotesList(filteredNotes);
                };

                // --- EVENT LISTENERS ---

                // Auto-save on text change in editor or tags
                quill.on('text-change', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(saveNote, 1000);
                });
                tagsInput.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(saveNote, 1000);
                });

                // Button clicks
                newNoteBtn.addEventListener('click', createNewNote);
                placeholderNewNoteLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    createNewNote();
                });
                deleteNoteBtn.addEventListener('click', deleteCurrentNote);
                
                // Search
                searchBar.addEventListener('input', searchNotes);

                // --- INITIALIZATION ---
                loadNotes();

            } catch (error) {
                // If anything catastrophic happens, display the error in the body
                document.body.innerHTML = `<div class="p-8">
                    <h2 class="text-xl font-bold text-red-500">A fatal error occurred in the Notes plugin:</h2>
                    <pre class="mt-4 text-red-300 bg-red-900/50 p-4 rounded">${error.stack}</pre>
                </div>`;
                console.error(error);
            }
        });
    </script>
</body>
</html>